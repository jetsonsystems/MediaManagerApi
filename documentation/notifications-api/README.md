# PLM Media Manager - Notifications API

  * [Overview](#Overview)
  * [The Web Socket Protocol](#The-Web-Socket-Protocol)
    * [Web Socket Connection](#Web-Socket-Connection)
    * [The Web Socket Event Protocol](#The-Web-Socket-Event-Protocol)
      * [Client -> API Service Events](#Client-API-Service-Events)
        * [Client: Subscribe Event](#Client-Subscribe-Event)
      * [API Service -> Client Events](#API-Service-Client-Events)
        * [API Service: Connection Events](#API-Service-Connection-Events)
        * [API Service: Error Events](#API-Service-Error-Events)
        * [API Service: /importers Events](#API-Service-importers-Events)
        * [API Service: /storage/synchronizers Events](#API-Service-storage-synchronizers-Events)
        * [API Service: /storage/changes-feed Events](#API-Service-storage-changes-feed-Events)
  * [Using The API](#Using-the-API)
    * [Notifications API WebSocket Emulator - MediaManager/MediaManagerApi/lib/NotificationsWsLike.js](#Notifications-API-WebSocket-Emulator)
  * [References](#References)

<a name="Overview"></a>
## Overview

The **PLM Meida Manager - Notifications API** provides a publish / subscribe interface to events generated by *resources*. A *resource* emitting an event can be one of the [PLM Media Manager - REST API](../rest-api/README.md) resources, or a predefined resource such as the client application. For example, events are emitted by the [PLM Media Manager - REST API's](../rest-api/README.md) [Importers - create](../rest-api/endpoints/importers.md#importers-create) endpoint to indicate that an import of documents has started, a document as been imported, and an import has completed. The following [PLM Media Manager - REST API](../rest-api/README.md) resources emit events which can be subscribed to:

  * [Importers Resource](../rest-api/endpoints/importers.md)
  * [Storage/Synchronizers Resource](../rest-api/endpoints/storage-synchronizers.md)

The API defines a [WebSocket](http://www.websocket.org/index.html) protocol such that a web client can connect to a *PLM Media Manager - Notifications Server* which implements the protocal over [WebSockets](http://www.websocket.org/index.html) as a web service. Also, a [node.js](http://www.nodejs.org/) library, [Notifications API WebSocket Emulator](#Notifications-API-WebSocket-Emulator) provides a WebSocket like interface to access the API without actually going over the wire. See [[NotificationsApi#Using-The-API|Using the API]].

The API is modeled loosely after the "The Pusher Protocol":http://pusher.com/docs/pusher_protocol. 

<a name="The-Web-Socket-Protocol"></a>
## The Web Socket Protocol

A client must establish a [[NotificationsAPI#Web-Socket-Connection|Web Socket Connection]]. Once, a *connection.established* event is received, the client may:

  * send *subscribe* events to the notifications API service,
  * receive events from API resources via the notifications API service.

The format of event messages is described in [[NotificationsApi#The-Web-Socket-Event-Protocol|The Web Socket Event Protocol]].

<a name="Web-Socket-Connection"></a>
### Web Socket Connection

Clients should make a connection to:

<pre>
    [scheme]://<host>:<port>/<version>/notifications
</pre>

where:

  * scheme: ws or wss
  * port: 80 (ws) or 443 (wss)
  * version: The protocal version being used. Default is v0.

<a name="The-Web-Socket-Event-Protocol"></a>
### The Web Socket Event Protocol

Messages in the protocol represent events, and have the following general message format:

<pre>
  {
    "resource": <resource emitting event>,
    "event": <event descriptor>,
    "data": {
      <event message body>
    }
  }
</pre>

Message flow in two directions, from the client to the API Service and from the API Service to the client.

Some  events emitted by API resources will reference document resources via a "doc_resource" attribute. This identifies the document resource by path. The following resources are supported:

  * "/images": A "doc" attribute may contain a representation of the resource whose format is Image Resource Format - Short Form.

<a name="Client-API-Service-Events"></a>
#### Client -> API Service Events

<a name="Client-Subscribe-Event"></a>
##### Client: Subscribe Event

The client should emit a subscribe event to receive event messages emitted by a particular API resource. Subscription events should NOT be sent until a *connection.established* event is received from the */notifications* resource.


  * Event format: <pre>
  {
    "resource": "_client",
    "event": "subscribe",
    "data": {
      "resource": <resource whose emitted events are being subscribed to>
    }
  }
</pre>
  * example:

    * Subscribe to events emitted by the */storage/synchronizers* resource: <pre>
  {
    "resource": "_client",
    "event": "subscribe",
    "data": {
      "resource": "/storage/synchronizers"
    }
  }
</pre>

<a name="API-Service-Client-Events"></a>
#### API Service -> Client Events

<a name="API-Service-Connection-Events"></a>
##### API Service: Connection Events

The API Service emits events when a connection is established, and as it changes. The following events may be emitted:

  * connection.established:

<pre>
  {
     "resource": "/notifications",
     "event": "connection.established"
  }
</pre>

<a name="API-Service-Error-Events"></a>
##### API Service: Error Events

      * Emitted anytime an error occurs that should be communicated to the client which may NOT be associated with a particular resource.

      {
        "resource": "/notications",
        "event": "error",
        "data": {
          "error_code": <error code>,
          "error_message": <error message>
        }
      }

<a name="API-Service-importers-Events""></a>
##### API Service: /importers Events

  * /importers General Event Format:
<pre>
    {
      "resource": "/importers",
      "event": <importer event>,
      "data": {
        <importer event data>
      }
    }
</pre>
  * import.started Event
<pre>
      "data": {
        <representation of importer resource>
      }
</pre>
  * import.completed Event
<pre>
      "data": {
        <representation of importer resource>
      }
</pre>
  * import.<document type>.created Event

    * Emitted the document is initially created. The representation will contain initial meta-data. In the case of an image, this will be meta-data obtained from parsing the image file.
<pre>    
      "data": {
        "id": <importer ID>,
        "doc_resource": <document resource>,
        "doc": <representation of imported resources>                
      }

      <document type> ::= Singular or plural resource name, IE: "image" or "images".
      <document resource> ::= Identifies the document resource by path. The following resources are currently supported:

        "/images": "doc" will contain a representation whose format is Image Resource Format - Short Form.

      <representation of imported resources> ::= <document representation> ||
                                                 [ <document representation>, ... <document representation> ]

        When <document type> is singular ("image"), "doc" contains the representation of a single resource. 
        Whereas when <document type> is plural ("impages"), then "doc" contains an array of resource representations.
</pre>
  * import.<document type>.variant.created Event

    * Emitted when a "variant" of the original document has been persisted. For example, in the case of images, this would be a resized version of the images has been associated withthe original image and persisted. The structure is the same as in the case of import.<document type>.created events.
    * <document type> may be singular or plural. For example, for an import.images.variant.created event, "doc" will contain an array of image document representations.
  * import.<document type>.imported Event

    * Emitted when the import process is complete for the document(s). The structureis the same as in the case of import.<document type>.created events.
    * <document type> may be singular or plural. For example, for an import.images.variant.created event, "doc" will contain an array of image document representations.
  * Notes:

    * Event though an import potentially saves a document multiple times, only ONE event is generated for a document after its import is completed. For example, for an image, the document is saved for each image variant. The event is emitted, after all variants are saved.
  * Examples:

    * import.started:
<pre>
  { 
    "resource": "/importers",
    "event": "import.started",
    "data": {
      "id": "$9575f12f-8934-4b0c-bca8-7c873d617ef4",
      "import_dir": "/Users/marekjulian/PLM",
      "created_at": "2013-02-01T23:05:53.665Z",
      "started_at": "2013-02-01T23:05:53.683Z",
      "num_to_import": 19,
      "num_imported": 0,
      "num_success": 0,
      "num_error":0
    }
  }
</pre>
    * import.image.saved:
<pre>
  {
    "resource":" /importers",
    "event": "import.image.saved",
    "data": {
      "id": "$9575f12f-8934-4b0c-bca8-7c873d617ef4",
      "doc_resource": "/images",
      "doc": {
        "id": "$d6611c90-8fbf-4c92-8d82-fd3ed73a1d01",
        "name": "L1000755.jpg",
        "path": "/Users/marekjulian/PLM/import/Crested Butte Selects/L1000755.jpg",
        "url": null,
        "format": "JPEG",
        "geometry": "5212x3468",
        "size": {
          "width": 5212,
          "height": 3468
        },
        "filesize": "1.3M",
        "checksum": "7cf676ebfe7918965e5ad3d52b8f6d8e",
        "created_at": "2013-02-01T23:05:53.686Z",
        "variants": [
          {
            "id": "$53896d7a-f838-4f08-8f58-d0cb15dde571",
            "name": "thumbnail.jpg",
            "url": "http://localhost:59840/plm-media-manager/53896d7a-f838-4f08-8f58-d0cb15dde571/thumbnail.jpg",
            "geometry":"132x88",
            "size":{"width":132,"height":88},
            "filesize":"44.9K",
            "created_at": "2013-02-01T23:05:53.686Z",
            "variants":[]
          },
          {
            "id": "$29abb6bd-f9e1-49f5-8b97-4eb9ee8ccdbd",
            "name": "web.jpg",
            "url": "http://localhost:59840/plm-media-manager/29abb6bd-f9e1-49f5-8b97-4eb9ee8ccdbd/web.jpg",
            "geometry": "601x400",
            "size": {"width":601,"height":400},
            "filesize": "82.4K",
            "created_at": "2013-02-01T23:05:53.686Z",
            "variants": []
          },
          {
            "id": "$943264f0-4a9b-49be-a5ff-26560df887a0",
            "name": "full-small.jpg",
            "url": "http://localhost:59840/plm-media-manager/943264f0-4a9b-49be-a5ff-26560df887a0/full-small.jpg",
            "geometry": "1202x800",
            "size": {"width":1202,"height":800},
            "filesize": "174.6K",
            "created_at": "2013-02-01T23:05:53.686Z",
            "variants":[]
          }
        ]
      }
    }
  }
</pre>
    * import.completed:
<pre>
  {
    "resource": "/importers",
    "event": "import.completed",
    "data": {
      "id": "$9575f12f-8934-4b0c-bca8-7c873d617ef4",
      "import_dir": "/Users/marekjulian/PLM",
      "created_at": "2013-02-01T23:05:53.665Z",
      "started_at": "2013-02-01T23:05:53.683Z",
      "completed_at": "2013-02-01T23:06:57.131Z",
      "num_to_import": 19,
      "num_imported": 19,
      "num_success": 19,
      "num_error": 0
    }
  }
</pre>

<a name="API-Service-storage-synchronizers-Events"></a>
##### API Service: /storage/synchronizers Events

  * /storage/synchronizers General Event Format:
<pre>
  {
    "resource": "/storage/synchronizers",
    "event": <storage sync event>,
    "data": {
       <storage sync event data>
    }
  }
</pre>
  * sync.started Event
<pre>
  "data": {
    <representation of storage synchronizers resource>
  }
</pre>
  * sync.completed Event
<pre>
  "data": {
    <representation of storage synchronizers resource>
  }
</pre>
  * Examples:

    * sync.started:
<pre>
  {
    "resource": "/storage/synchronizers",
    "event":"sync.started",
    "data": {
      "id": "$4563fb4d-29f4-497f-b524-c083aaa311c5+3a47b353-294f-44e5-b44e-ca3041b0909d",
      "state":"triggered",
      "push": {
        "id": "$4563fb4d-29f4-497f-b524-c083aaa311c5"
      },
      "pull": {
        "id": "$3a47b353-294f-44e5-b44e-ca3041b0909d"
      }
    }
  }
</pre>
    * sync.completed:
<pre>
  {
    "resource": "/storage/synchronizers",
    "event": "sync.completed",
    "data": {
      "id": "$4563fb4d-29f4-497f-b524-c083aaa311c5+3a47b353-294f-44e5-b44e-ca3041b0909d",
      "state": "completed",
      "push": {
        "id": "$4563fb4d-29f4-497f-b524-c083aaa311c5",
        "state": "completed"
      },
      "pull": {
        "id": "$3a47b353-294f-44e5-b44e-ca3041b0909d",
        "state": "completed"
      }
    }
  }
</pre>

<a name="API-Service-storage-changes-feed-Events"></a>
##### API Service: /storage/changes-feed Events

  * /storage/changes-feed General Event Format:
<pre>
  {
    "resource": "/storage/changes-feed",
    "event": <storage changes event>,
    "data": {
      <storage change event data>
    }
  }
</pre>
  * doc.<document type>.created Event
<pre>
    "data": {
      "doc_resource": <document resource>,
      "doc": {
        <representation of created document>                
      }
    }

    <document type> ::= Singler resource name. The following <document type>s are currently supported:

      image: An instances of a /images resource.
      importer: An instance of an /importers resource.

    <document resource> ::= Identifies the document resource by path. The following resources are currently supported:

      /images: "doc" will contain a representation of the image resource in Image Resource Format - Short Form.
      /importers: "doc" will contain a representation of an importer resource.

</pre>
  * doc.<document type>.updated Event
<pre>
    "data": {
      "doc_resource": <document resource>,
      "doc": {
        <representation of updated document>                
      }
    }
</pre>
  * doc.<document type>.deleted Event
<pre>
    "data": {
      "doc_resource": <document resource>,
      "doc": {
        "id": <document ID>
      }
    }
</pre>
  * Notes:
 
    * Multiple events may be emitted for "image" documents as each associated image variant is saved. It is the event consumer's responsibility to react to the appropriate event.
    * A document may contain a "app_id" attribute. This attribute can be used to disambiguate documents which have been imported on the local host, vs. ones which have been pulled in via a *sync*. Note, both a import.<document type>.saved event and a doc.<document type>.created or doc.<document type>.updated event will be received when a document is imported on the current host. However, NO import.<document type>.saved event will be received for documents which are synced.

  * Examples:

    * doc.importer.created:
<pre>
  {
    "resource": "/storage/changes-feed",
    "event": "doc.importer.created",
    "data": {
      "doc_resource": "/importers",
      "doc": {
         "id": "$5093fd94-2171-4641-a863-ff6eda3ae594",
         "app_id": "$9f970b9b-482e-4612-9305-84d85017cd70",
         "import_dir": "/Users/marekjulian/PLM",
         "created_at": "2013-02-06T23:52:43.327Z",
         "num_to_import": 19,
         "num_success": 0,
         "num_error": 0
        }
      }
    }
  }
</pre>
    * doc.image.created:
<pre>
  {
    "resource": "/storage/changes-feed",
    "event": "doc.image.created",
    "data": {
      "doc_resource": "/images",
      "doc": {
        "id": "$ef38e0d3-c4ad-4eab-9821-9b2fbf64dd4d",
        "app_id": "$9f970b9b-482e-4612-9305-84d85017cd70",
        "importer_id": "$63af9a2f-239e-4a62-8df8-3b6261fab316",
        "name": "L1000755.jpg",
        "path": "/Users/marekjulian/PLM/import/Crested Butte Selects/L1000755.jpg",
        "format": "JPEG",
        "geometry": "5212x3468",
        "size": {"width":5212,"height":3468},
        "filesize": "1.3M",
        "checksum": "7cf676ebfe7918965e5ad3d52b8f6d8e",
        "created_at": "2013-02-05T23:03:08.401Z"
      }
    }
  }
</pre>
    * doc.image.updated:
<pre>

  {
    "resource": "/storage/changes-feed",
    "event": "doc.image.updated",
    "data": {
      "doc_resource": "/images",
      "doc": {
        "id": "$ef38e0d3-c4ad-4eab-9821-9b2fbf64dd4d",
        "app_id": "$9f970b9b-482e-4612-9305-84d85017cd70",
        "importer_id": "$63af9a2f-239e-4a62-8df8-3b6261fab316",
        "name": "L1000755.jpg",
        "path": "/Users/marekjulian/PLM/import/Crested Butte Selects/L1000755.jpg",
        "url": null,
        "format": "JPEG",
        "geometry": "5212x3468", 
        "size": {"width":5212,"height":3468},
        "filesize": "1.3M",
        "checksum": "7cf676ebfe7918965e5ad3d52b8f6d8e",
        "created_at": "2013-02-05T23:03:08.401Z",
        "variants": [
          {
            "id": "$a73e2a78-e083-45b4-9f1b-a5a724155d57",
            "app_id": "$9f970b9b-482e-4612-9305-84d85017cd70",
            "importer_id": "$63af9a2f-239e-4a62-8df8-3b6261fab316",
            "name": "thumbnail.jpg",
            "url": "http://localhost:59840/plm-media-manager/a73e2a78-e083-45b4-9f1b-a5a724155d57/thumbnail.jpg",
            "geometry": "132x88",
            "size": {"width":132,"height":88},
            "filesize":"44.9K",
            "created_at": "2013-02-05T23:03:08.401Z","variants":[]
          },
          {
            "id": "$e99561c0-5a32-41c2-8899-f5c5640fd076",
            "app_id": "$9f970b9b-482e-4612-9305-84d85017cd70",
            "importer_id": "$63af9a2f-239e-4a62-8df8-3b6261fab316",
            "name": "web.jpg",
            "url": "http://localhost:59840/plm-media-manager/e99561c0-5a32-41c2-8899-f5c5640fd076/web.jpg",
            "geometry": "601x400",
            "size": {"width":601,"height":400},
            "filesize": "82.4K",
            "created_at": "2013-02-05T23:03:08.401Z",
            "variants":[]
          },
          {
            "id": "$9d192b9f-c0ef-4723-b4fa-13245c832abd",
            "app_id": "$9f970b9b-482e-4612-9305-84d85017cd70",
            "importer_id": "$63af9a2f-239e-4a62-8df8-3b6261fab316",
            "name": "full-small.jpg",
            "url": "http://localhost:59840/plm-media-manager/9d192b9f-c0ef-4723-b4fa-13245c832abd/full-small.jpg",
            "geometry":"1202x800",
            "size": {"width":1202,"height":800},
            "filesize":"174.6K",
            "created_at": "2013-02-05T23:03:08.401Z",
            "variants": []
          }
        ]
      }
    }
  }
</pre>

<a name="Using-the-API"></a>
## Using The API

<a name="Notifications-API-WebSocket-Emulator"></a>
### Notifications API WebSocket Emulator - MediaManager/MediaManagerApi/lib/NotificationsWsLike.js

A "node.js":http://nodejs.org based module is provided which implements a shim emulating a real WebSocket object and its interface. The intent is for the client side AppJS based application to utilize this module on the desktop to receive notifications via the protocol defined in this document without actually going over the wire via real WebSockets.

The module is a drop-in replacement for the actual "HTML5 web-socket API":http://dev.w3.org/html5/websockets/.

The following code fragment illustrates utilizing the module in the browser context: <pre>
    var WebSocket = require('MediaManagerApi/lib/NotificationsWsLike');
    var ws = new WebSocket('ws://appjs/notifications');

    ws.onmessage = function(msg) {
      console.log('Got message - ' + msg.data);
    };

    ws.send(JSON.stringify({
      "resource": "_client", 
      "event": "subscribe",
      "data": {
        "resource": "/storage/synchronizers" 
    }}));
</pre>.

In the above example, a onmessage handler is registered which simply logs events received to the console. Then a subscription event is sent which subscribes to events generated by the /storage/synchronizers resource. Running the above fragment via node yields a connection established event being set to the client side: <pre>
    Got message - {"resource":"/notifications","event":"connection.established"}
</pre>.

<a name="References"></a>
## References

  * Web Sockets:

    * "WebSocket.org":http://www.websocket.org/index.html
    * "The WebSocket API":http://dev.w3.org/html5/websockets/

  * "The Pusher Protocal":http://pusher.com/docs/pusher_protocol


